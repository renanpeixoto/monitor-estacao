<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Resumo da Estação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f3f4f6; }
    header { background: #0f766e; color: #fff; padding: 1rem 1.2rem; }
    main { padding: 1.2rem; max-width: 1200px; margin: 0 auto; }

    .controls {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      align-items: center;
    }
    input, button {
      padding: .35rem .6rem;
      font-size: .9rem;
    }
    button {
      background: #0f766e;
      color: #fff;
      border: none;
      border-radius: .25rem;
      cursor: pointer;
    }
    button:hover { background: #115e57; }
    .status { font-size: .8rem; color: #475569; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: .75rem;
      margin-bottom: 1rem;
    }
    .card {
      background: #fff;
      border-radius: .5rem;
      padding: .75rem .9rem;
      box-shadow: 0 1px 3px rgba(15, 23, 42, .1);
    }
    .card-title {
      font-size: .7rem;
      color: #64748b;
      margin-bottom: .35rem;
      text-transform: uppercase;
    }
    .card-value { font-size: 1.3rem; font-weight: 600; }
    .card-sub { font-size: .7rem; color: #94a3b8; }

    .section {
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 1px 3px rgba(15,23,42,.1);
      padding: .75rem 1rem 1rem;
      margin-bottom: 1rem;
    }
    .section-title {
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-bottom: .5rem;
      font-weight: 600;
    }

    @media (max-width: 880px) {
      .controls { flex-direction: column; align-items: flex-start; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.1rem;">Resumo da Estação</h1>
    <p style="margin:.2rem 0 0;font-size:.8rem;">Projeto ARCA • LAPMAR / UFPA • API: Railway • Dados: PostgreSQL</p>
  </header>

  <main>
    <div class="controls">
      <div>
        <label for="stationId">Estação:</label>
        <input type="number" id="stationId" value="1" min="1" style="width:4rem;">
      </div>
      <div>
        <label for="limit">Registros usados na média:</label>
        <input type="number" id="limit" value="50" min="10" max="500" style="width:4.5rem;">
      </div>
      <button id="reloadBtn">Atualizar agora</button>
      <span id="status" class="status">Carregando...</span>
    </div>

    <!-- cards com médias -->
    <div class="cards">
      <div class="card">
        <div class="card-title">Temp. ar média (°C)</div>
        <div class="card-value" id="avg-air-temp">—</div>
        <div class="card-sub" id="avg-air-temp-info"></div>
      </div>
      <div class="card">
        <div class="card-title">Umidade média (%)</div>
        <div class="card-value" id="avg-air-humid">—</div>
        <div class="card-sub" id="avg-air-humid-info"></div>
      </div>
      <div class="card">
        <div class="card-title">Vento méd (m/s)</div>
        <div class="card-value" id="avg-wind-mean">—</div>
        <div class="card-sub" id="avg-wind-mean-info"></div>
      </div>
      <div class="card">
        <div class="card-title">Temp. água média (°C)</div>
        <div class="card-value" id="avg-water-temp">—</div>
        <div class="card-sub" id="avg-water-temp-info"></div>
      </div>
    </div>

    <!-- gráficos simples -->
    <div class="section">
      <div class="section-title">
        <span>Temperatura do ar (série temporal)</span>
        <span style="font-size:.75rem;color:#64748b;" id="air-temp-range"></span>
      </div>
      <canvas id="airTempChart" height="110"></canvas>
    </div>

    <div class="section">
      <div class="section-title">
        <span>Temperatura da água (série temporal)</span>
        <span style="font-size:.75rem;color:#64748b;" id="water-temp-range"></span>
      </div>
      <canvas id="waterTempChart" height="110"></canvas>
    </div>
  </main>

  <script>
    const API_BASE = "https://apiestacao-production.up.railway.app";

    const statusEl = document.getElementById("status");
    const stationInput = document.getElementById("stationId");
    const limitInput = document.getElementById("limit");
    const btn = document.getElementById("reloadBtn");

    // cards
    const avgAirTempEl = document.getElementById("avg-air-temp");
    const avgAirTempInfoEl = document.getElementById("avg-air-temp-info");
    const avgAirHumidEl = document.getElementById("avg-air-humid");
    const avgAirHumidInfoEl = document.getElementById("avg-air-humid-info");
    const avgWindMeanEl = document.getElementById("avg-wind-mean");
    const avgWindMeanInfoEl = document.getElementById("avg-wind-mean-info");
    const avgWaterTempEl = document.getElementById("avg-water-temp");
    const avgWaterTempInfoEl = document.getElementById("avg-water-temp-info");

    const airTempRangeEl = document.getElementById("air-temp-range");
    const waterTempRangeEl = document.getElementById("water-temp-range");

    let latestData = [];
    let airTempChart = null;
    let waterTempChart = null;

    function formatDateToBelem(iso) {
      if (!iso) return "";
      const date = new Date(iso);
      return date.toLocaleString("pt-BR", { timeZone: "America/Belem" });
    }

    function computeMean(data, field) {
      let sum = 0;
      let count = 0;
      for (const row of data) {
        const v = row[field];
        if (v !== null && v !== undefined) {
          sum += Number(v);
          count += 1;
        }
      }
      if (count === 0) return null;
      return sum / count;
    }

    function fmtMean(val, decimals = 2) {
      if (val === null || val === undefined || Number.isNaN(val)) return "—";
      return val.toFixed(decimals);
    }

    async function loadData() {
      const stationId = stationInput.value || 1;
      const limit = limitInput.value || 50;
      statusEl.textContent = `Carregando últimos ${limit} registros da estação ${stationId}...`;

      try {
        const resp = await fetch(`${API_BASE}/latest?station_id=${stationId}&limit=${limit}`);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const json = await resp.json();
        const data = json.data || [];
        latestData = data;

        if (data.length === 0) {
          statusEl.textContent = "Nenhum dado disponível para essa estação.";
          return;
        }

        // ordenar da mais antiga para a mais recente para gráficos e infos
        const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
        const first = sorted[0];
        const last = sorted[sorted.length - 1];
        const rangeLabel = `${formatDateToBelem(first.date)} → ${formatDateToBelem(last.date)}`;

        // médias
        const meanAirTemp = computeMean(data, "air_temperature");
        const meanAirHumid = computeMean(data, "air_humid");
        const meanWindMean = computeMean(data, "wind_speed_mean");
        const meanWaterTemp = computeMean(data, "water_temperature");

        avgAirTempEl.textContent = fmtMean(meanAirTemp, 1);
        avgAirTempInfoEl.textContent = `média dos últimos ${data.length} registros`;
        avgAirHumidEl.textContent = fmtMean(meanAirHumid, 1);
        avgAirHumidInfoEl.textContent = `média dos últimos ${data.length} registros`;
        avgWindMeanEl.textContent = fmtMean(meanWindMean, 2);
        avgWindMeanInfoEl.textContent = `média dos últimos ${data.length} registros`;
        avgWaterTempEl.textContent = fmtMean(meanWaterTemp, 2);
        avgWaterTempInfoEl.textContent = `média dos últimos ${data.length} registros`;

        // gráficos
        updateCharts(sorted);

        airTempRangeEl.textContent = rangeLabel;
        waterTempRangeEl.textContent = rangeLabel;

        statusEl.textContent = `Dados atualizados. Usando ${data.length} registros da estação ${stationId}.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Erro ao carregar dados. Veja o console.";
      }
    }

    function updateCharts(sortedData) {
      const labels = sortedData.map(row => formatDateToBelem(row.date));
      const airTempValues = sortedData.map(row =>
        row.air_temperature == null ? null : Number(row.air_temperature)
      );
      const waterTempValues = sortedData.map(row =>
        row.water_temperature == null ? null : Number(row.water_temperature)
      );

      const airCtx = document.getElementById("airTempChart").getContext("2d");
      const waterCtx = document.getElementById("waterTempChart").getContext("2d");

      if (airTempChart) {
        airTempChart.data.labels = labels;
        airTempChart.data.datasets[0].data = airTempValues;
        airTempChart.update();
      } else {
        airTempChart = new Chart(airCtx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Temperatura do ar (°C)",
              data: airTempValues,
              borderColor: "rgba(15,118,110,1)",
              backgroundColor: "rgba(15,118,110,0.15)",
              tension: 0.2,
              spanGaps: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { maxTicksLimit: 8 } },
              y: { beginAtZero: false }
            }
          }
        });
      }

      if (waterTempChart) {
        waterTempChart.data.labels = labels;
        waterTempChart.data.datasets[0].data = waterTempValues;
        waterTempChart.update();
      } else {
        waterTempChart = new Chart(waterCtx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Temperatura da água (°C)",
              data: waterTempValues,
              borderColor: "rgba(59,130,246,1)",
              backgroundColor: "rgba(59,130,246,0.15)",
              tension: 0.2,
              spanGaps: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { maxTicksLimit: 8 } },
              y: { beginAtZero: false }
            }
          }
        });
      }
    }

    btn.addEventListener("click", loadData);

    // primeira carga + atualização periódica
    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>


