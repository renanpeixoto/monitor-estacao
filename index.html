<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Resumo da Estação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f3f4f6; }
    header { background: #0f766e; color: #fff; padding: 1rem 1.2rem; }
    main { padding: 1.2rem; max-width: 1200px; margin: 0 auto; }

    .controls {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-bottom: .25rem;
      align-items: center;
    }
    input, button, select {
      padding: .35rem .6rem;
      font-size: .9rem;
    }
    button {
      background: #0f766e;
      color: #fff;
      border: none;
      border-radius: .25rem;
      cursor: pointer;
    }
    button:hover { background: #115e57; }
    .status { font-size: .8rem; color: #475569; }

    .info-text {
      font-size: .75rem;
      color: #64748b;
      margin-bottom: .9rem;
      max-width: 60rem;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: .75rem;
      margin-bottom: 1rem;
    }
    .card {
      background: #fff;
      border-radius: .5rem;
      padding: .75rem .9rem;
      box-shadow: 0 1px 3px rgba(15, 23, 42, .1);
    }
    .card-title {
      font-size: .7rem;
      color: #64748b;
      margin-bottom: .35rem;
      text-transform: uppercase;
    }
    .card-value { font-size: 1.3rem; font-weight: 600; }
    .card-sub { font-size: .7rem; color: #94a3b8; margin-top: .25rem; }

    .section {
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 1px 3px rgba(15,23,42,.1);
      padding: .75rem 1rem 1rem;
      margin-bottom: 1rem;
    }
    .section-title {
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-bottom: .5rem;
      font-weight: 600;
    }
    .section-title select { font-size: .8rem; }

    @media (max-width: 880px) {
      .controls { flex-direction: column; align-items: flex-start; }
      .info-text { max-width: 100%; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.1rem;">Resumo da Estação</h1>
    <p style="margin:.2rem 0 0;font-size:.8rem;">Projeto ARCA • LAPMAR / UFPA • API: Railway • Dados: PostgreSQL</p>
  </header>

  <main>
    <div class="controls">
      <div>
        <label for="stationId">Estação:</label>
        <input type="number" id="stationId" value="1" min="1" style="width:4rem;">
      </div>
      <div>
        <label for="limit">Registros usados nas estatísticas:</label>
        <input type="number" id="limit" value="50" min="10" max="500" style="width:4.5rem;">
      </div>
      <button id="reloadBtn">Atualizar agora</button>
      <span id="status" class="status">Carregando...</span>
    </div>

    <p class="info-text">
      Dados observados em <strong>tempo quase real</strong>, sujeitos a falhas de comunicação, ausência pontual de registros e manutenção dos sensores.
    </p>

    <!-- CARDS -->
    <div class="cards">
      <div class="card">
        <div class="card-title">Temperatura do ar (°C)</div>
        <div class="card-value" id="last-air-temp">—</div>
        <div class="card-sub" id="mean-air-temp">Média: —</div>
      </div>
      <div class="card">
        <div class="card-title">Umidade relativa (%)</div>
        <div class="card-value" id="last-air-humid">—</div>
        <div class="card-sub" id="mean-air-humid">Média: —</div>
      </div>
      <div class="card">
        <div class="card-title">Vento médio (m/s)</div>
        <div class="card-value" id="last-wind-mean">—</div>
        <div class="card-sub" id="mean-wind-mean">Média: —</div>
      </div>
      <div class="card">
        <div class="card-title">Direção do vento (°)</div>
        <div class="card-value" id="last-wind-dir">—</div>
        <div class="card-sub" id="mode-wind-dir">Moda (predom.): —</div>
      </div>
      <div class="card">
        <div class="card-title">Pressão atmosférica (hPa)</div>
        <div class="card-value" id="last-air-pressure">—</div>
        <div class="card-sub" id="mean-air-pressure">Média: —</div>
      </div>
      <div class="card">
        <div class="card-title">Temperatura da água (°C)</div>
        <div class="card-value" id="last-water-temp">—</div>
        <div class="card-sub" id="mean-water-temp">Média: —</div>
      </div>
      <div class="card">
        <div class="card-title">Nível de água (m)</div>
        <div class="card-value" id="last-water-level">—</div>
        <div class="card-sub" id="mean-water-level">Média: —</div>
      </div>
    </div>

    <!-- GRÁFICO ATMOSFÉRICO -->
    <div class="section">
      <div class="section-title">
        <span>Série temporal — Atmosfera</span>
        <label>
          Variável:
          <select id="atmoParam">
            <option value="air_temperature">Temperatura do ar</option>
            <option value="air_humid">Umidade (%)</option>
            <option value="wind_speed_mean">Vento médio (m/s)</option>
            <option value="air_pressure">Pressão (hPa)</option>
            <option value="wind_direction">Direção do vento (°)</option>
          </select>
        </label>
      </div>
      <small id="atmo-range" style="color:#64748b"></small>
      <canvas id="atmoChart" height="110"></canvas>
    </div>

    <!-- GRÁFICO ÁGUA -->
    <div class="section">
      <div class="section-title">
        <span>Série temporal — Água</span>
        <label>
          Variável:
          <select id="waterParam">
            <option value="water_temperature">Temp. água (°C)</option>
            <option value="water_level">Nível de água (m)</option>
          </select>
        </label>
      </div>
      <small id="water-range" style="color:#64748b"></small>
      <canvas id="waterChart" height="110"></canvas>
    </div>
  </main>

  <script>
    const API_BASE = "https://apiestacao-production.up.railway.app";

    const statusEl = document.getElementById("status");
    const stationInput = document.getElementById("stationId");
    const limitInput = document.getElementById("limit");
    const btn = document.getElementById("reloadBtn");

    // cards
    const C = {
      lastAirTemp: document.getElementById("last-air-temp"),
      lastAirHumid: document.getElementById("last-air-humid"),
      lastWindMean: document.getElementById("last-wind-mean"),
      lastWindDir: document.getElementById("last-wind-dir"),
      lastAirPressure: document.getElementById("last-air-pressure"),
      lastWaterTemp: document.getElementById("last-water-temp"),
      lastWaterLevel: document.getElementById("last-water-level"),

      meanAirTemp: document.getElementById("mean-air-temp"),
      meanAirHumid: document.getElementById("mean-air-humid"),
      meanWindMean: document.getElementById("mean-wind-mean"),
      modeWindDir: document.getElementById("mode-wind-dir"),
      meanAirPressure: document.getElementById("mean-air-pressure"),
      meanWaterTemp: document.getElementById("mean-water-temp"),
      meanWaterLevel: document.getElementById("mean-water-level"),
    };

    const atmoRangeEl = document.getElementById("atmo-range");
    const waterRangeEl = document.getElementById("water-range");
    const atmoParam = document.getElementById("atmoParam");
    const waterParam = document.getElementById("waterParam");

    let latestData = [];
    let atmoChart = null;
    let waterChart = null;

    function fmt(v, d=2) { return v==null ? "—" : Number(v).toFixed(d); }

    function toBelém(t) {
      return new Date(t).toLocaleString("pt-BR", { timeZone: "America/Belem" });
    }

    function mean(data, field) {
      const vals = data.map(r => r[field]).filter(v => v!=null);
      if (!vals.length) return null;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    }

    function modeWind(data) {
      const freq = {};
      data.forEach(r => {
        if (r.wind_direction!=null)
          freq[Math.round(r.wind_direction)] = (freq[Math.round(r.wind_direction)]||0)+1;
      });
      let best=null, cnt=0;
      for (const k in freq)
        if (freq[k]>cnt) {cnt=freq[k]; best=k;}
      return best;
    }

    function series(data, field) {
      return {
        labels: data.map(r => toBelém(r.date)),
        values: data.map(r => r[field]==null?null:Number(r[field]))
      };
    }

    async function loadObserved() {
      const station = stationInput.value;
      const limit = limitInput.value;

      statusEl.textContent = "Carregando…";

      const resp = await fetch(`${API_BASE}/latest?station_id=${station}&limit=${limit}`);
      const json = await resp.json();
      const rows = json.data || [];

      if (!rows.length) {
        statusEl.textContent = "Sem dados.";
        return;
      }

      const sorted = [...rows].sort((a,b)=>new Date(a.date)-new Date(b.date));
      latestData = sorted;

      const last = sorted[sorted.length-1];

      // preencher cards (últimos)
      C.lastAirTemp.textContent = fmt(last.air_temperature,1);
      C.lastAirHumid.textContent = fmt(last.air_humid,1);
      C.lastWindMean.textContent = fmt(last.wind_speed_mean,2);
      C.lastWindDir.textContent = last.wind_direction!=null ? `${Math.round(last.wind_direction)}°` : "—";
      C.lastAirPressure.textContent = fmt(last.air_pressure,1);
      C.lastWaterTemp.textContent = fmt(last.water_temperature,2);
      C.lastWaterLevel.textContent = fmt(last.water_level,2);

      // médias / moda
      C.meanAirTemp.textContent = `Média: ${fmt(mean(sorted,"air_temperature"),1)}`;
      C.meanAirHumid.textContent = `Média: ${fmt(mean(sorted,"air_humid"),1)}`;
      C.meanWindMean.textContent = `Média: ${fmt(mean(sorted,"wind_speed_mean"),2)}`;
      C.meanAirPressure.textContent = `Média: ${fmt(mean(sorted,"air_pressure"),1)}`;
      C.meanWaterTemp.textContent = `Média: ${fmt(mean(sorted,"water_temperature"),2)}`;
      C.meanWaterLevel.textContent = `Média: ${fmt(mean(sorted,"water_level"),2)}`;
      C.modeWindDir.textContent = `Moda (predom.): ${modeWind(sorted)??"—"}°`;

      // intervalo temporal
      atmoRangeEl.textContent =
        `${toBelém(sorted[0].date)} → ${toBelém(sorted[sorted.length-1].date)}`;
      waterRangeEl.textContent = atmoRangeEl.textContent;

      updateCharts();

      statusEl.textContent = "Atualizado.";
    }

    function updateCharts() {
      const atmoField = atmoParam.value;
      const waterField = waterParam.value;

      const atmoS = series(latestData, atmoField);
      const waterS = series(latestData, waterField);

      const ctxA = document.getElementById("atmoChart").getContext("2d");
      const ctxW = document.getElementById("waterChart").getContext("2d");

      const labelPretty = {
        air_temperature: "Temperatura do ar (°C)",
        air_humid: "Umidade (%)",
        wind_speed_mean: "Vento médio (m/s)",
        air_pressure: "Pressão (hPa)",
        wind_direction: "Direção do vento (°)",
        water_temperature: "Temperatura da água (°C)",
        water_level: "Nível de água (m)"
      };

      // atmosfera
      if (atmoChart) {
        atmoChart.data.labels = atmoS.labels;
        atmoChart.data.datasets[0].data = atmoS.values;
        atmoChart.data.datasets[0].label = labelPretty[atmoField];
        atmoChart.update();
      } else {
        atmoChart = new Chart(ctxA, {
          type: "line",
          data: {
            labels: atmoS.labels,
            datasets: [{
              label: labelPretty[atmoField],
              data: atmoS.values,
              borderColor: "rgba(15,118,110,1)",
              backgroundColor: "rgba(15,118,110,0.15)",
              tension: 0.2,
              spanGaps: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            interaction: { mode:'index', intersect:false },
            plugins: {legend:{display:true}},
            scales: {y:{beginAtZero:false}}
          }
        });
      }

      // água
      if (waterChart) {
        waterChart.data.labels = waterS.labels;
        waterChart.data.datasets[0].data = waterS.values;
        waterChart.data.datasets[0].label = labelPretty[waterField];
        waterChart.update();
      } else {
        waterChart = new Chart(ctxW, {
          type: "line",
          data: {
            labels: waterS.labels,
            datasets: [{
              label: labelPretty[waterField],
              data: waterS.values,
              borderColor: "rgba(59,130,246,1)",
              backgroundColor: "rgba(59,130,246,0.15)",
              tension: 0.2,
              spanGaps: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            interaction: { mode:'index', intersect:false },
            plugins: {legend:{display:true}},
            scales: {y:{beginAtZero:false}}
          }
        });
      }
    }

    btn.addEventListener("click", loadObserved);
    atmoParam.addEventListener("change", updateCharts);
    waterParam.addEventListener("change", updateCharts);

    loadObserved();
    setInterval(loadObserved, 60000);
  </script>
</body>
</html>





